{
  "hash": "ec8b46bd192c6ca8b0e8fdf2ac839a02",
  "result": {
    "engine": "knitr",
    "markdown": "---\ntitle: Adobe Analytics API Dynamic ITP Report\nauthor: Ben R Woodard\ndate: '2022-01-18'\ncategories: [adobe analytics, adobeanalyticsr]\ntags: [itp, adobeanalyticsr, analytics]\n\nimage: \"/images/itpimpactreport.png\"\n\nformat: html    # ‚Üê REQUIRED so partials load correctly\n\ntoc: false\ntitle-block-banner: false\n---\n\n::: {.cell}\n\n```{.r .cell-code}\n#Setup chunk options\nknitr::opts_chunk$set(echo = TRUE,\n                      warning = FALSE,\n                      message = FALSE,\n                      eval = FALSE)\n```\n:::\n\n\n<div class=\"alert alert-dismissible alert-info\">\n  <button type=\"button\" class=\"btn-close\" data-bs-dismiss=\"alert\"></button>\n  <strong>Heads up!</strong>  Measuring ITP impact is a classic example of attempting to measure a \"moving target\". The example below uses segment definitions that were effective at showing the impact of ITP on traffic as of late 2021. This is for demonstration purposes only.\n</div>\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\n#install.packages('adobeanalyticsr')\n# Download packages needed for the report\nlibrary(adobeanalyticsr) #pulls data from Adobe Analytics\nlibrary(tidyverse) #used in data wrangling\nlibrary(scales) #used for visually cleaner numbers\nlibrary(lubridate) #makes working with dates much easier\n# library(itpreportr) #internal r package\n\naw_auth('s2s')\n```\n:::\n\n\n## Setup for the ITP impact report\n\nThe first setup step is identifying the report suite you are going to be using for the report.  This can be as easily as looking in the admin for Adobe Analytics or running the `aw_get_reportsuites()` function in adobeanalyticsr.  Either way, this step should be fairly simple.  \n\nThe second step is usually done through training and reviews but when using code we can generate visuals that more consistently aligned with our expectations.  While visuals are still customized for each report, this type of code based deliverable enables us to include visualization best practices into all of our reports and presentations.\n\nFinally, the last step of our setup process is creating the segments and calculated metrics. Historically, we have needed to go into a report suite and create these elements. There were problems with consistent naming conventions and other user errors due to having so many 'touch points' in that process. By using the API we have been able to streamline this step in the setup process. It is now a single function that first checks for existing segments with the same name in the account and then builds them if they do not exist. \n\nThe power of this report is in the ability to automate the segment creation process and then pull data according to each segment without ever having to log into the user interface.  Since the segment definitions use basic dimensions and metrics, there is no need to customize these dimensions across report suite.\n\n\n::: {.cell}\n\n```{.r .cell-code}\n#Define the ReportSuite to be used\nrsid <- 'lumalucaslidemo'\n\n## Get the base ggplot theme design attributes\ntt <- tim_themes()\n\n## Get the Segment ID's\n### create the segments and calculated metric\nsegids <- create_itp_segments()\n### assign the ids needed to call the appropriate data\nbest_seg <- segids$bestseg\nworst_seg <- segids$worstseg\nreturn_seg <- segids$returnseg\nreturn_cm <- segids$returncm\n```\n:::\n\n\n## Visualize the Impact\n\nNow that we have the setup done, we can get right into the visualization part.  This has been a hot topic among my peers on the best way to present the ITP Impact. The following visuals are adjusted a little (or a lot) with every client presentation but they give us a solid start to communicating the impact of ITP on their analytics. \n\n### 90 Day View\n\nThe first visual shows the distribution of the 'Best Case' Traffic estimate vs the 'Worst Case' Traffic segments over the last 90 days.\n\n1. First we need to pull the 3 different data sets using the segments.  \n\n - We add one column to the results, 'type', to help make the distinction between data sets.\n\n\n::: {.cell}\n\n```{.r .cell-code}\n#pull the all traffic 90 day data\nall.ninetydays <- aw_freeform_table(rsid = rsid,\n                                    date_range = c(Sys.Date()-91, Sys.Date()-1),\n                                    dimensions = 'daterangeday',\n                                    metrics = 'visits') %>%\n                    mutate(type = 'all.visits')\n#pull the best case segment traffic 90 day data\nbest.ninetydays <- aw_freeform_table(rsid = rsid, \n                                    date_range = c(Sys.Date()-91, Sys.Date()-1),\n                                    dimensions = 'daterangeday',\n                                    metrics = c('visits'),\n                                    segmentId = best_seg) %>%\n                    mutate(type = 'best.case')\n#pull the worst case segment traffic 90 day data\nworst.ninetydays <- aw_freeform_table(rsid = rsid,\n                                      date_range = c(Sys.Date()-91, Sys.Date()-1),\n                                      dimensions = 'daterangeday',\n                                      metrics = c('visits'),\n                                      segmentId = worst_seg) %>%\n                    mutate(type = 'worst.case')\n```\n:::\n\n\n2. Now we need to combine the data.\n\n  - Due to the fact that all the columns are the same we can use the base `rbind` function.\n\n::: {.cell}\n\n```{.r .cell-code}\n#row bind the data together\nninetydays <- rbind(best.ninetydays, worst.ninetydays, all.ninetydays)\n```\n:::\n\n\n3. Before creating the visual we need the averages and annotations.\n\n  - This step includes 2 summary data points to help provide additional information on the chart\n\n::: {.cell}\n\n```{.r .cell-code}\n#transform the data a bit to present percentages\navg_traffic <- ninetydays %>%\n  pivot_wider(names_from = type, values_from = visits) %>%\n  mutate(bestcase_prop = round(best.case/all.visits, digits = 2),\n         worstcase_prop = round(worst.case/all.visits, digits = 2)) %>%\n  mutate(avg_worst = round(mean(worstcase_prop), digits = 2),\n         avg_best = round(mean(bestcase_prop), digits = 2)) %>%\n  distinct(avg_worst, avg_best)\n#define where the annotations should appear on the chart\nannotation_location <- ninetydays %>%\n  filter(daterangeday == max(ninetydays$daterangeday)-30) %>%\n  pivot_wider(names_from = type, values_from = visits) %>%\n  mutate(bestcase_prop = round(best.case/all.visits, digits = 2),\n         worstcase_prop = round(worst.case/all.visits, digits = 2)) %>%\n  select(daterangeday, bestcase_prop, worstcase_prop)\n```\n:::\n\n\n4. Finally we create the visual.\n\n  - This can look intimidating at first but visual customization is a big reason for doing the ITP Impact Report in R\n  - We usually only have to adjust the 2 items commented below in the code. ('#' signifies a comment)\n\n::: {.cell}\n\n```{.r .cell-code}\n#create the visualization using the data\nninetydays %>%\n  pivot_wider(names_from = type, values_from = visits) %>%\n  mutate(bestcase_prop = round(best.case/all.visits, digits = 2),\n         worstcase_prop = round(worst.case/all.visits, digits = 2)) %>%\n  mutate(avg_worst = round(mean(worstcase_prop), digits = 2),\n         avg_best = round(mean(bestcase_prop), digits = 2)) %>%\n  select(daterangeday,bestcase_prop, worstcase_prop, avg_worst, avg_best) %>%\n  pivot_longer(cols = 2:3) %>%\n  ggplot(aes(daterangeday, value, color = name)) + \n  geom_line() +\n  scale_color_manual(values = c('#F58220', '#009CAB')) +\n  scale_y_continuous(labels = scales::percent, limits = c(0, 1) ) +\n  annotate('text', \n           label= glue::glue('Worst Case Avg. \\n {scales::percent(avg_traffic$avg_worst)}'),  \n           x = max(ninetydays$daterangeday)-10, \n           y = annotation_location$worstcase_prop + .29, #adjust the distance from the 'worst' line on the graph\n           color = '#009CAB', \n           fill = 'white') +\n  annotate('text', \n           label= glue::glue('Best Case Avg. \\n {scales::percent(avg_traffic$avg_best)}'),  \n           x = max(ninetydays$daterangeday)-10, \n           y = annotation_location$bestcase_prop + .15, #adjust the distance from the 'best' line on the graph\n           color = '#F58220', \n           fill = 'white') +\n  tt$theme_lines +\n  theme(legend.position = 'none', title = element_text(vjust = 1), \n        plot.title = element_text(face = 'plain', hjust = 0.0), \n        plot.subtitle = element_text(color = '#333333', vjust =5), \n        plot.caption = element_text(color = '#888888', face = 'italic', size = 8) ) +\n  labs(title = \"Estimated Best and Worst Case ITP Impacted Traffic\", \n       subtitle = '90 Day Traffic Trend and Average', \n       caption = glue::glue('Data Source: reportsuite *rsid*'))\n```\n:::\n\n\n## Larger Trend by Month\n\nThis next visual gives a larger look-back window and summarizes it by month as opposed to day.  It is intended to help the analyst answer the following questions:\n\n  - Has traffic  been steady, increasing, or decreasing? \n  - Do we see seasonality trends?  \n  \nIt also should inform whether or not we will expect changes going forward for volume of Best and Worst Case visits.\n\n1. Pull the data\n\nBecause we want the best look-back window possible we start by defining how many days March 1, 2020 was from today.  This number will be used in the function argument `date_range` to make sure we include much of 2020 without having to do much additional math. We could add the data in the character form, '2020-04-01', but then we would have to define today's date in the same character format in order for the `c()` function to send in the date range correctly.  It's easier to define the days since today and then just subtract it from today's date. \n\n\n::: {.cell}\n\n```{.r .cell-code}\n#determine the number of days to subtract from today\ndayssince200401 <- as.numeric(Sys.Date()-1 - as.Date('2020-04-01'))\n#pull the data\nall.12months <- aw_freeform_table(rsid = rsid,\n                                    date_range = c(Sys.Date()-dayssince200401, Sys.Date()-1),\n                                    dimensions = 'daterangemonth',\n                                    metrics = c('visits')) %>%\n                    mutate(type = 'all.visits')\nbest.12months <- aw_freeform_table(rsid = rsid, \n                                    date_range = c(Sys.Date()-dayssince200401, Sys.Date()-1),\n                                    dimensions = 'daterangemonth',\n                                    metrics = c('visits'),\n                                    segmentId = best_seg) %>%\n                    mutate(type = 'best.case')\nworst.12months <- aw_freeform_table(rsid = rsid,\n                                      date_range = c(Sys.Date()-dayssince200401, Sys.Date()-1),\n                                      dimensions = 'daterangemonth',\n                                      metrics = c('visits'),\n                                      segmentId = worst_seg) %>%\n                    mutate(type = 'worst.case')\n```\n:::\n\n\n2. Bind the rows \n\n::: {.cell}\n\n```{.r .cell-code}\n## bind the data sets together\ntwelvemonths <- rbind(best.12months, worst.12months, all.12months)\n```\n:::\n\n\n3. Get additional data points\n\n- As in the previous section, we need to do a little data wrangling to get additional points of information.\n\n::: {.cell}\n\n```{.r .cell-code}\n# Transform the daterangemonth column to date, just in case.\ntwelvemonths <- twelvemonths %>%\n  mutate(date = lubridate::my(daterangemonth)) \n# Define how man months we are looking at\nmonthscount <- length(unique(twelvemonths$daterangemonth))\n# Get the averages in traffic\navg_traffic <- twelvemonths %>%\n  pivot_wider(names_from = type, values_from = visits) %>%\n  mutate(bestcase_prop = round(best.case/all.visits, digits = 2),\n         worstcase_prop = round(worst.case/all.visits, digits = 2)) %>%\n  mutate(avg_worst = round(mean(worstcase_prop), digits = 2),\n         avg_best = round(mean(bestcase_prop), digits = 2)) %>%\n  distinct(avg_worst, avg_best)\n# Define the annotations needed for the visual\nannotation_location <- twelvemonths %>%\n  filter(date == max(floor_date(twelvemonths$date))) %>%\n  pivot_wider(names_from = type, values_from = visits) %>%\n  mutate(bestcase_prop = round(best.case/all.visits, digits = 2),\n         worstcase_prop = round(worst.case/all.visits, digits = 2)) %>%\n  select(date, bestcase_prop, worstcase_prop)\n```\n:::\n\n\n4. Visualize the longer trended data\n\n::: {.cell}\n\n```{.r .cell-code}\ntwelvemonths %>%\n  pivot_wider(names_from = type, values_from = visits) %>%\n  mutate(bestcase_prop = round(best.case/all.visits, digits = 2),\n         worstcase_prop = round(worst.case/all.visits, digits = 2)) %>%\n  mutate(avg_worst = round(mean(worstcase_prop), digits = 2),\n         avg_best = round(mean(bestcase_prop), digits = 2)) %>%\n  select(date, bestcase_prop, worstcase_prop, avg_worst, avg_best) %>%\n  pivot_longer(cols = 2:3) %>%\n  ggplot(aes(date, value, color = name)) + \n  geom_line() +\n  scale_color_manual(values = c('#F58220', '#009CAB')) +\n  annotate('text', \n           label= glue::glue('Worst Case'),  \n           x = max(twelvemonths$date)-30, \n           y = annotation_location$worstcase_prop + .07, \n           color = '#009CAB', \n           fill = 'white') +\n  annotate('text', \n           label= glue::glue('Best Case'),  \n           x = max(twelvemonths$date)-30, \n           y = annotation_location$bestcase_prop + .07, \n           color = '#F58220', \n           fill = 'white') +\n  tt$theme_lines +\n  theme(legend.position = 'none', \n        title = element_text(vjust = 1), \n        plot.title = element_text(face = 'plain', hjust = 0.0), \n        plot.subtitle = element_text(color = '#333333', vjust =5), \n        plot.caption = element_text(color = '#888888', face = 'italic', size = 8)) +\n  geom_vline(xintercept = as.Date('2020-11-04'), #this mark the vertical line when ITP was launched\n             color = 'light grey', linetype = 3) +\n  annotate('text', \n           label = 'Nov 5 Apple ITP', \n           angle = 90, x = as.Date('2020-10-30'), \n           y = .75, color = 'light grey') +\n  scale_y_continuous(labels = percent, limits = c(0, 1) ) +\n  scale_x_date(breaks = '2 months', date_labels = \"%b '%y\") +\n  labs(title = \"Apple OS Traffic Has Been Increasing\", #change the title\n       subtitle = glue::glue('{monthscount} Month ITP At Risk Traffic'), #change the subtitle\n       caption = glue::glue('Data Source: reportsuite *rsid*')) \n```\n:::\n\n\n## Example of ITP Analytics Impact\n\nThis final visual takes the percentage of returning after 7 day visits before and after the date ITP was implemented on November 5th, 2020. It is used to illustrate of one of the impacts of ITP on reporting.\n\n1. Pull the data\n\n\n::: {.cell}\n\n```{.r .cell-code}\ndr = c(as.Date('2020-05-01'), Sys.Date()-1)\nall.prev12 <- aw_freeform_table(rsid = rsid,\n                                date_range = dr,\n                                dimensions = 'daterangemonth',\n                                metrics = c('visits', return_cm),\n                                prettynames = F) %>%\n                    mutate(type = 'all.visits')  %>%\n  dplyr::rename(visits7days = 3)\n\nbest.prev12 <- aw_freeform_table(rsid = rsid, \n                                    date_range = dr,\n                                    dimensions = 'daterangemonth',\n                                    metrics = c('visits', return_cm),\n                                    segmentId = best_seg,\n                                  prettynames = F) %>%\n  mutate(type = 'best.case') %>% \n  dplyr::rename(visits7days = 3)\n\nworst.prev12 <- aw_freeform_table(rsid = rsid,\n                                      date_range = dr,\n                                      dimensions = 'daterangemonth',\n                                      metrics = c('visits', return_cm),\n                                      segmentId = worst_seg,\n                                   prettynames = F) %>%\n  mutate(type = 'worst.case') %>% \n  dplyr::rename(visits7days = 3)\n```\n:::\n\n\n2. Bind the data\n\n::: {.cell}\n\n```{.r .cell-code}\nprev12 <- rbind(best.prev12, worst.prev12, all.prev12)\n```\n:::\n\n\n3. Transform the data\n\n- The biggest change in this step over the previous transformation steps is categorizing the date as being 'after' or 'before' the ITP changes. \n\n::: {.cell}\n\n```{.r .cell-code}\nprev12 <- prev12 %>%\n  mutate(date = lubridate::my(daterangemonth)) \n\navg7dayreturns <- prev12 %>%\n  mutate(sinceitp = if_else(date > as.Date('2020-10-31'), 'After', 'Before'))\n```\n:::\n\n\n4. Visualize the data\n\n::: {.cell}\n\n```{.r .cell-code}\navg7dayreturns %>%\n  mutate(type = case_when(type == 'all.visits' ~ 'All Visits', \n                          type == 'best.case' ~ 'Recent Apple OS',\n                          type == 'worst.case' ~ 'All Apple OS')) %>%\n  group_by(sinceitp, type) %>%\n  summarise(avg7dayreturns = sum(visits7days, na.rm = T)/sum(visits, na.rm = T)) %>%\n  mutate(type = factor(type, levels = c('All Visits', 'All Apple OS', 'Recent Apple OS'))) %>%\n  mutate(sinceitp = factor(sinceitp, levels = c('Before', 'After'))) %>%\n  filter(type != 'Recent Apple OS') %>%\n  ggplot(aes(type, avg7dayreturns, fill = sinceitp)) + \n  geom_bar(stat = 'identity', position = position_dodge(width = .75 ), width = .7) +\n  geom_text(aes(label = percent(avg7dayreturns, accuracy = 1)), position = position_dodge(width = .75), vjust =1.3, color = '#efefef', size = 7) +\n  tt$theme_bar_nolines +\n  scale_y_continuous(expand = c(0, 0)) +\n  theme(axis.text.y = element_blank(), legend.position = c(1,1.1), legend.justification = c(1,1),\n              legend.background = element_blank(), plot.title = element_text(hjust = 0, vjust = -2),\n        plot.caption = element_text(face = 'italic', size = 6)) +\n  scale_fill_manual(values = c('#F58220', '#009CAB')) +\n  labs(title = \"Average Post 7 Day Return Traffic Is Decreasing\", \n       subtitle = 'Before and After Apple Implemented ITP Changes - Average Return Traffic',\n       caption = glue::glue('ITP Change: Nov. 5, 2020 \\n Data Source: reportsuite *rsid*'))\n```\n:::\n\n\nUsing this framework creates the images but most importantly, enables the analyst to quickly add in-line commentary and recommendations to the final deliverable.",
    "supporting": [],
    "filters": [
      "rmarkdown/pagebreak.lua"
    ],
    "includes": {},
    "engineDependencies": {},
    "preserve": {},
    "postProcess": true
  }
}